<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<p>Loading...</p>
<img src="" alt="" id="imageTest">
<script type="text/javascript" src="https://unpkg.com/morphdom@2.6.1/dist/morphdom-umd.js"></script>
<script type="text/javascript" src="https://unpkg.com/localforage@1.7.4/dist/localforage.js"></script>
<script type="text/javascript" src="https://unpkg.com/js-md5@0.7.3/src/md5.js"></script>
<script type="module">
    import init, {app, Request} from './pkg/shared_space.js';

    localforage.config({
        name: 'shared-space',
        version: 1.0,
        driver: localforage.INDEXEDDB
    });

    async function readAsDataUrl(blob) {
        return new Promise((resolve) => {
            var reader = new FileReader();

            reader.onload = function () {
                resolve(reader.result);
            }

            reader.readAsDataURL(blob);
        });
    }

    async function readAsBinaryString(blob) {
        return new Promise((resolve) => {
            var reader = new FileReader();

            reader.onload = function () {
                resolve(reader.result);
            }

            reader.readAsBinaryString(blob);
        });
    }

    async function processRequest(request) {

        let response = await app(request);

        if (response.status_code === "303") {
            let redirectRequest = new Request(JSON.parse(response.headers).Location, "GET");

            return processRequest(redirectRequest);

        } else {
            morphdom(document.documentElement, response.body);
        }
    }

    document.addEventListener('submit', async function (event) {
        event.preventDefault();

        let form = event.target.closest('form');
        var formData = new FormData(form);

        var object = await Array.from(formData).reduce(async function (acc, formDataEntry) {
            var value = formDataEntry[1];
            var key = formDataEntry[0];

            if (value instanceof File) {
                let blob = new Blob([value], {type: value.type});
                let blobDataUrl = await readAsBinaryString(blob);
                let hash = md5(blobDataUrl);

                await localforage.setItem(hash, blob);
                // File { name: "Screen Shot 2020-05-22 at 1.57.58 PM.png", lastModified: 1590173883832, webkitRelativePath: "", size: 110484, type: "image/png" }
                acc[key] = {
                    name: value.name,
                    last_modified: value.lastModified,
                    size: value.size,
                    file_type: value.type,
                    location: hash
                }
            } else {
                acc[key] = value;
            }
            return acc;

        }, {});

        var formBodyAsJSON = JSON.stringify(object);

        let request = new Request("/files", "POST");
        request.body = formBodyAsJSON;

        await processRequest(request);
    })


    async function run() {
        await init();
        let request = new Request("/files", "GET");

        await processRequest(request);


    }

    run();
</script>
</body>
</html>